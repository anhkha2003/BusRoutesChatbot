<!DOCTYPE html>
<html>
  <head>
    <title>Simple Chat Bot</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        background-color: #f5e6ca;
        display: flex;
        justify-content: center;
        align-items: center; 
        flex-direction: column;
      }

      #chat-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 500px; 
        height: 600px;
        border: 2px solid #9b7653;
        padding: 15px;
        background-color: #fff;
        margin-bottom: 15px;
        overflow-y: scroll;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      #chat-header {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
        background-color: #0056b3;
        padding: 10px 20px; 
        border-radius: 5px;
        color: white;
        position: sticky;
        top: 0; 
        z-index: 1;
        width: 495px;
        text-align: center;
      }

      #chat-window {
        flex: 1;
        width: 100%;
        font-family: Calibri, sans-serif;
        display: flex;
        flex-direction: column;
      }

      .chat-bubble {
        background-color: #007BFF;
        color: white;
        padding: 10px;
        border-radius: 10px;
        margin: 10px 0;
        max-width: 80%; 
        word-wrap: break-word;
        display: flex;
        align-items: center;
      }

      .user {
        background-color: #02386e;
        align-self: flex-end; 
        float:right;
      }

      .bot {
        clear: both;
        background-color: #007BFF;
        align-self: flex-start;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        background-image: url('https://img.freepik.com/premium-vector/account-icon-user-icon-vector-graphics_292645-552.jpg');
        background-size: cover;
      }

      .bot-avatar {
        background-image: url('https://media.istockphoto.com/id/1060696342/vector/robot-icon-chat-bot-sign-for-support-service-concept-chatbot-character-flat-style.jpg?s=612x612&w=0&k=20&c=t9PsSDLowOAhfL1v683JMtWRDdF8w5CFsICqQvEvfzY=');
      }

      #message-input-container {
        display: flex;
        flex-direction: row;
        align-items: center;
        width: 100%;
        padding: 15px;
        position: sticky;
        bottom: 0; 
        background-color: #fff; 
        z-index: 1; 
      }

      #insert-file-button {
        background-color: #007BFF;
        color: white;
        border: none;
        padding: 10px 15px; 
        border-radius: 5px; 
        cursor: pointer;
      }

      #insert-file-button:hover {
        background-color: #0056b3;
      }

      #chat-input {
        flex: 1;
        border: none;
        padding: 10px; 
        border-radius: 5px; 
        margin-right: 10px;
        max-width: 100%;
      }

      #send-button {
        background-color: #007BFF;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px; 
        cursor: pointer;
      }

      #send-button:hover {
        background-color: #0056b3;
      }
    </style>
    <script>
      let allMessages = ['{{bot_message}}'];
      function scrollToBottom() {
        var chatContainer = document.getElementById('chat-container');
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
      function sendMessage() {
        var message = $('#chat-input').val();
        $('#chat-window').append('<div class="chat-bubble user"><div class="avatar"></div>' + message + '</div>');
        $('#chat-input').val('');
        scrollToBottom();
        var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
        allMessages.push(message);
        $.ajax({
          url: "{% url 'submit_view' %}",
          type: 'POST',
          headers: {"X-CSRFToken": csrftoken},
          data: {
            messages: allMessages
          },
          success: function(data) {
            $('#chat-window').append('<div class="chat-bubble bot"><div class="bot-avatar avatar"></div>' + data.message + '</div></div>');
            allMessages.push(data.message);
            scrollToBottom();
          },
          error: function(error) {
            console.log('Error:', error);
          }
        });
      }
      function uploadFile(file) {
        var formData = new FormData();
        formData.append('file', file);
        var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

        $.ajax({
          url: "{% url 'upload_view' %}",
          type: 'POST',
          headers: {"X-CSRFToken": csrftoken},
          data: formData,
          processData: false,
          contentType: false,
          success: function(data) {
            console.log('Upload successfully')
          },
          error: function(error) {
            console.log('Error:', error);
          }
        });
      }
      $(document).ready(function(){
        $('#chat-window').append('<div class="chat-bubble bot"><div class="bot-avatar avatar"></div>' + '{{bot_message}}' + '</div></div>');
        $('#send-button').on('click', sendMessage);
        $('#chat-input').on('keypress', function(e) {
          if(e.which == 13) {
            sendMessage()
          }
        });
        $('#fileUploadInput').change(function() {
          if (this.files.length > 0) {
            uploadedFile = this.files[0]; 
            $('#fileName').text(uploadedFile.name); 
            uploadFile(uploadedFile);
          }
        });
      });
    </script>
  </head>
  <body>
    {% csrf_token %}
    <h1 id="chat-header">Restaurant Assistant</h1>
    <div id="chat-container">
      <div id="chat-window"></div>
      <div id="message-input-container">
        <button id="insert-file-button" onclick="document.getElementById('fileUploadInput').click()" style="color: white; font-weight: bold;">
            <i class="fas fa-paperclip"></i>
        </button>
        <input id="fileUploadInput" type="file" accept=".txt,.pdf,.docx" style="display: none;">
        <input id="chat-input" type="text" placeholder="Type a message...">
        <span id="fileName"></span>
        <button id="send-button">Send</button>
      </div>
    </div>
  </body>
</html>
